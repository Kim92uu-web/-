<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>金硕珍的来信</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* --- 基础设置 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #000;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-family: 'Noto Sans SC', sans-serif;
            position: relative;
        }

        /* --- 阶段一：手机聊天界面 --- */
        #phone-screen {
            width: 100%;
            height: 100%;
            background: #1c1c1e;
            position: absolute;
            top: 0; left: 0;
            z-index: 200;
            display: flex;
            flex-direction: column;
            transition: opacity 1.5s ease, transform 1.5s ease;
        }

        .chat-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1c1c1e;
            color: #fff;
            border-bottom: 1px solid #2c2c2e;
            font-size: 17px;
            font-weight: 500;
            padding-top: 10px;
        }

        .chat-area {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow-y: auto;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(10px);
            animation: popIn 0.3s forwards;
            word-wrap: break-word;
        }

        .message.received { background: #2c2c2e; color: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }
        .message.sent { background: #0A84FF; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }

        .input-area {
            padding: 15px; /* iPhone 底部安全区 */
            padding-bottom: 40px;
            background: #1c1c1e;
            border-top: 1px solid #2c2c2e;
        }

        .fake-input {
            width: 100%;
            padding: 12px 15px;
            background: #000;
            border-radius: 20px;
            color: #fff;
            font-size: 15px;
            min-height: 44px;
            display: flex;
            align-items: center;
        }

        .typing-cursor::after { content: '|'; animation: blink 1s infinite; color: #0A84FF; margin-left: 2px; }

        .start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 300;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 14px; letter-spacing: 1px;
            transition: opacity 0.5s; cursor: pointer;
        }

        /* --- 阶段二：信件场景 --- */
        #letter-scene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 2s ease;
            font-family: 'Ma Shan Zheng', cursive;
            perspective: 1000px;
            overflow: hidden;
        }
        #letter-scene.active { opacity: 1; pointer-events: auto; }

        /* 雨滴画布 */
        #rain-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* 信封容器 */
        .envelope-wrapper {
            position: relative;
            width: 80vw; /* 适配手机宽度 */
            max-width: 320px;
            height: 55vw; /* 按比例 */
            max-height: 220px;
            background: #4a3b32;
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            cursor: pointer;
            z-index: 20;
            transition: transform 0.5s;
        }
        
        /* 信封部件 */
        .lid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-top: 110px solid #5d4a3f; /* 调整盖子大小 */
            border-left: 160px solid transparent; border-right: 160px solid transparent;
            transform-origin: top; transition: transform 0.8s ease 0.5s, z-index 0.2s 0.5s; z-index: 30;
            pointer-events: none;
        }
        .lid.open { transform: rotateX(180deg); z-index: 1; }

        .pocket {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            border-bottom: 110px solid #6b564a;
            border-left: 160px solid transparent; border-right: 160px solid transparent;
            z-index: 25; pointer-events: none;
        }

        .seal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 46px; height: 46px; background: #8B0000; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 40;
            display: flex; justify-content: center; align-items: center;
            color: rgba(255,255,255,0.4); font-size: 14px; border: 2px dashed rgba(255,255,255,0.1);
            transition: opacity 0.5s, transform 0.5s;
        }
        .seal.broken { opacity: 0; transform: translate(-50%, -50%) scale(1.5); pointer-events: none; }

        /* --- 核心修复：信纸 --- */
        .letter {
            position: absolute;
            bottom: 5px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 90%;
            background: #f4e4bc;
            background-image: linear-gradient(#e3d1a8 1px, transparent 1px);
            background-size: 100% 30px; /* 行间距 */
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            z-index: 5; /* 初始在口袋后面 */
            transition: all 1s ease 0.8s; /* 延迟动画 */
            overflow: hidden;
            display: flex; 
            flex-direction: column;
        }

        /* 信纸展开后的状态 - 这里的CSS是关键修复 */
        .letter.open {
            position: fixed; /* 脱离信封，相对于屏幕定位 */
            top: 10%; /* 距离顶部 */
            bottom: 10%; /* 距离底部 */
            height: auto; /* 自动撑满中间区域 */
            width: 90vw; /* 屏幕宽度的90% */
            max-width: 400px; /* 限制最大宽度 */
            left: 50%;
            transform: translateX(-50%); /* 居中 */
            z-index: 100; /* 最顶层 */
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            overflow-y: auto; /* 允许纵向滚动 */
            -webkit-overflow-scrolling: touch; /* 丝滑滚动 */
            padding-bottom: 50px; /* 底部留白 */
        }

        /* 滚动条美化 */
        .letter::-webkit-scrollbar { width: 4px; }
        .letter::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 2px; }

        .text-line {
            opacity: 0;
            margin-bottom: 10px;
            font-size: 18px; /* 调大字号 */
            line-height: 30px; /* 对齐信纸横线 */
            color: #2c2c2c;
            flex-shrink: 0; /* 防止文字被压缩 */
        }
        
        .fade-in { animation: fadeInEffect 1.5s forwards; }
        .hint-text { position: absolute; bottom: -40px; width: 100%; text-align: center; color: #aaa; font-size: 12px; animation: blink 2s infinite; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInEffect { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <!-- ⚠️ 请务必替换这里的链接 -->
    <audio id="bgm" loop preload="auto">
        <source src="https://music.163.com/song/media/outer/url?id=1386599528.mp3" type="audio/mpeg">
    </audio>

    <!-- 阶段一：手机界面 -->
    <div id="phone-screen">
        <div class="start-overlay" id="start-btn">
            <div>► 点击开始回忆</div>
        </div>
        <div class="chat-header">金硕珍 (Jin)</div>
        <div class="chat-area" id="chat-box">
            <!-- 消息动态生成 -->
        </div>
        <div class="input-area">
            <div class="fake-input typing-cursor" id="input-text"></div>
        </div>
    </div>

    <!-- 阶段二：信件界面 -->
    <div id="letter-scene">
        <canvas id="rain-canvas"></canvas>
        <div class="envelope-wrapper" id="envelope">
            <div class="lid" id="lid"></div>
            <div class="letter" id="letter">
                <div class="text-line">User，展信佳。</div>
                <div class="text-line">北水的雨季又要到了，不知道你那里有没有带伞。</div>
                <div class="text-line">原谅我用这种方式告别，面对你，我怕我会心软。</div>
                <div class="text-line">曾经那个穿白衬衫的少年，已经死在还不完的账单里了。</div>
                <div class="text-line">现在的我双手太脏，抱不紧你，也给不了你想要的未来。</div>
                <div class="text-line">爱是真的，但想让你走也是真的。</div>
                <div class="text-line">别等我了，那个无底洞太深，不该把你这束光也拽进来。</div>
                <div class="text-line">你应该去找个能在下雨天为你送伞的人，而不是像我这样。</div>
                <div class="text-line">忘了我，这是我对你最后的请求，也是我最后的爱意。</div>
                <div class="text-line" style="text-align: right; margin-top: 30px;">—— 那个已成过去的 金硕珍</div>
                <div style="height: 50px;"></div> <!-- 底部占位符 -->
            </div>
            <div class="pocket"></div>
            <div class="seal" id="seal">Jin</div>
            <div class="hint-text" id="open-hint">点击开启</div>
        </div>
    </div>

    <script>
        // --- 逻辑控制 ---
        const startBtn = document.getElementById('start-btn');
        const phoneScreen = document.getElementById('phone-screen');
        const chatBox = document.getElementById('chat-box');
        const inputText = document.getElementById('input-text');
        const letterScene = document.getElementById('letter-scene');
        const bgm = document.getElementById('bgm');

        // 剧情脚本
        let step = 0;

        startBtn.addEventListener('click', () => {
            startBtn.style.opacity = 0;
            setTimeout(() => startBtn.style.display = 'none', 500);
            
            // 修复：在这里触发音乐，确保移动端能播放
            bgm.volume = 0.6;
            bgm.play().then(() => {
                console.log("BGM playing");
            }).catch(e => {
                console.log("Audio play failed, waiting for next interaction", e);
            });

            runDrama();
        });

        async function typeText(text) {
            inputText.innerText = "";
            for (let i = 0; i < text.length; i++) {
                inputText.innerText += text[i];
                // 随机打字速度，模拟真人
                await new Promise(r => setTimeout(r, 80 + Math.random() * 100)); 
            }
            await new Promise(r => setTimeout(r, 600)); // 思考停顿
        }

        async function deleteText() {
            let text = inputText.innerText;
            while (text.length > 0) {
                text = text.slice(0, -1);
                inputText.innerText = text;
                await new Promise(r => setTimeout(r, 30)); // 快速删除
            }
        }

        function addMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'message received';
            msg.innerText = text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight; // 自动滚动到底部
        }

        async function runDrama() {
            // 1. 犹豫输入
            await new Promise(r => setTimeout(r, 1000));
            await typeText("其实我不想分手的...");
            await new Promise(r => setTimeout(r, 800));
            await deleteText();

            // 2. 再次尝试
            await typeText("我真的很想见你");
            await new Promise(r => setTimeout(r, 1000));
            await deleteText();

            // 3. 决绝发送
            await typeText("我们算了吧。");
            await new Promise(r => setTimeout(r, 500));
            inputText.innerText = ""; // 发送清空
            addMessage("我们算了吧。");
            
            await new Promise(r => setTimeout(r, 1500));
            
            await typeText("别等我了，不值得。");
            inputText.innerText = "";
            addMessage("别等我了，不值得。");

            // 4. 转场
            await new Promise(r => setTimeout(r, 2500));
            phoneScreen.style.opacity = 0;
            phoneScreen.style.transform = "scale(0.95)";
            
            setTimeout(() => {
                phoneScreen.style.display = 'none';
                letterScene.classList.add('active');
            }, 1500);
        }

        // --- 信件交互 ---
        const envelope = document.getElementById('envelope');
        const lid = document.getElementById('lid');
        const letter = document.getElementById('letter');
        const seal = document.getElementById('seal');
        const openHint = document.getElementById('open-hint');
        const lines = document.querySelectorAll('.text-line');
        let isOpened = false;

        envelope.addEventListener('click', function() {
            if (isOpened) return;
            isOpened = true;

            openHint.style.display = 'none';
            seal.classList.add('broken');
            
            // 动画序列
            setTimeout(() => lid.classList.add('open'), 200);
            setTimeout(() => letter.classList.add('open'), 800);
            
            // 文字逐行显现
            let delay = 1800; // 等待信纸展开
            lines.forEach((line, index) => {
                setTimeout(() => {
                    line.classList.add('fade-in');
                    // 每显示一行，自动尝试向下滚动一点点
                    if(index > 3) {
                       letter.scrollTop = letter.scrollHeight; 
                    }
                }, delay + (index * 1200));
            });
        });

        // --- 雨滴特效 ---
        const rCanvas = document.getElementById('rain-canvas');
        const rCtx = rCanvas.getContext('2d');
        
        function resizeCanvas() {
            rCanvas.width = window.innerWidth;
            rCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        const rains = [];
        class Rain {
            constructor() {
                this.x = Math.random() * rCanvas.width;
                this.y = Math.random() * rCanvas.height;
                this.length = Math.random() * 20 + 10;
                this.speed = Math.random() * 5 + 5;
            }
            update() {
                this.y += this.speed;
                if (this.y > rCanvas.height) {
                    this.y = -this.length;
                    this.x = Math.random() * rCanvas.width;
                }
            }
            draw() {
                rCtx.strokeStyle = 'rgba(174,194,224,0.3)';
                rCtx.lineWidth = 1.5;
                rCtx.beginPath();
                rCtx.moveTo(this.x, this.y);
                rCtx.lineTo(this.x, this.y + this.length);
                rCtx.stroke();
            }
        }
        for(let i=0; i<80; i++) rains.push(new Rain());
        
        function animateRain() {
            rCtx.clearRect(0, 0, rCanvas.width, rCanvas.height);
            rains.forEach(r => { r.update(); r.draw(); });
            requestAnimationFrame(animateRain);
        }
        animateRain();

    </script>
</body>
</html>
